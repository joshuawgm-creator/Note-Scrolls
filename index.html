<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Note Scrolls</title>

<!-- Lexend font -->
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg: #f6fbff;
    --panel: #ffffff;
    --muted: #6b7280;
    --accent: #2563eb;
    --accent-2: #06b6d4;
    --radius: 12px;
    --shadow: 0 10px 30px rgba(16,24,40,0.08);
    --toolbar-h: 48px;
    --welcome-padding: 18px;
    --reminder-height: 72px; /* reserve space for absolute reminder */
  }

  html,body{
    height:100%;
    margin:0;
    font-family: "Lexend", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    background: linear-gradient(180deg,#eef8ff 0%, #ffffff 100%);
    color: #0f172a;
  }

  .app {
    width:100%;
    max-width:1400px;
    height:90vh;
    margin:20px auto;
    background:var(--panel);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    display:flex;
    overflow:hidden;
  }

  /* Sidebar */
  .sidebar {
    width:220px;
    min-width:180px;
    padding:14px;
    border-right:1px solid rgba(15,23,42,0.04);
    background: linear-gradient(180deg, rgba(37,99,235,0.03), rgba(6,182,212,0.02));
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:flex-start;
  }

  .brand {
    display:flex;
    gap:10px;
    align-items:center;
    width:100%;
  }
  .logo {
    width:44px;height:44px;border-radius:10px;
    background: linear-gradient(135deg,var(--accent),var(--accent-2));
    display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:16px;
    box-shadow: 0 8px 22px rgba(37,99,235,0.12);
    flex-shrink:0;
  }
  .brand-text { display:flex;flex-direction:column;gap:2px;min-width:0; }
  .brand-text .title { font-size:14px;font-weight:700;line-height:1;color:#071033;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
  .brand-text .subtitle { font-size:12px;color:var(--muted); }

  /* Auth card */
  .card { width:100%; background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.9)); border-radius:10px; padding:10px; box-shadow: 0 6px 18px rgba(2,6,23,0.04); }
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="text"], input[type="password"]{
    width:100%;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);
    background:transparent;font-size:13px;box-sizing:border-box;
  }
  .row{display:flex;gap:8px}
  .primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border:0;padding:8px;border-radius:8px;cursor:pointer;font-weight:600}
  .ghost{background:transparent;border:1px solid rgba(15,23,42,0.06);padding:8px;border-radius:8px;cursor:pointer}

  /* User card */
  .user-card { display:none; width:100%; padding:10px; box-sizing:border-box; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.9)); box-shadow: 0 6px 18px rgba(2,6,23,0.04); }
  .user-row { display:flex; align-items:center; gap:10px; }
  .user-avatar { width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,#111827,#374151);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0; }
  .user-meta { display:flex;flex-direction:column; gap:2px; min-width:0; }
  .user-meta .label { font-size:11px;color:var(--muted); }
  .user-meta .name { font-size:13px;font-weight:700;color:#071033; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .user-actions { margin-left:auto; display:flex; gap:6px; }

  .btn-logout { background:transparent;border:1px solid rgba(15,23,42,0.06);padding:6px 8px;border-radius:8px;font-size:12px;cursor:pointer;color:var(--muted); }
  .btn-logout:hover { background:rgba(15,23,42,0.03); color:#071033; }

  .small-note { font-size:12px;color:var(--muted); }

  /* Editor area */
  .editor-wrap { flex:1; display:flex; flex-direction:column; padding:10px; min-width:0; min-height:0; }
  .topbar { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
  .tabs { display:flex; gap:6px; align-items:center; flex-wrap:nowrap; overflow:auto; padding-bottom:4px; min-width:0; }
  .tab { display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius:8px; background:rgba(15,23,42,0.03); cursor:pointer; font-weight:600; white-space:nowrap; max-width:220px; overflow:hidden; text-overflow:ellipsis; font-size:13px; }
  .tab.active { background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:white; box-shadow: 0 8px 20px rgba(37,99,235,0.12); }
  .tab .close { font-size:12px; opacity:0.9; padding:2px 6px; border-radius:6px; cursor:pointer; background: rgba(255,255,255,0.06); }
  .tab .close:hover { background: rgba(255,255,255,0.12); }
  .add-tab { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:8px; background:rgba(37,99,235,0.08); cursor:pointer; font-weight:700; color:var(--accent); flex-shrink:0; }

  .toolbar { height:var(--toolbar-h); display:flex; align-items:center; gap:8px; padding:6px; border-radius:8px; background: linear-gradient(90deg, rgba(255,255,255,0.6), rgba(255,255,255,0.4)); border:1px solid rgba(15,23,42,0.04); margin-left:auto; }
  .tool-btn { display:inline-flex; align-items:center; gap:8px; padding:6px 8px; border-radius:8px; border:0; background:transparent; cursor:pointer; color:var(--muted); font-size:13px; }
  .tool-btn:hover { background:rgba(15,23,42,0.03); color:#071033; }

  #editor-container { position:relative; flex:1; display:flex; flex-direction:column; min-width:0; min-height:0; }
  /* Welcome is a column; reminder is anchored to bottom using absolute positioning */
  #welcome {
    padding: var(--welcome-padding);
    color:var(--muted);
    overflow:auto;
    flex:1;
    min-height:0;
    display:flex;
    flex-direction:column;
    gap:12px;
    position:relative; /* container for absolute reminder */
    padding-bottom: calc(var(--welcome-padding) + var(--reminder-height)); /* reserve space so content doesn't hide behind reminder */
  }
  #welcome h2 { margin-top:0; color:var(--accent); font-size:18px; }
  #editor { display:none; flex:1; padding:18px; border-radius:10px; background:linear-gradient(180deg,#fff,#fbfdff); border:1px solid rgba(15,23,42,0.04); overflow:auto; position:relative; min-height:0; font-size:15px; line-height:1.5; }
  #editor[contenteditable="true"] { outline:none; white-space:normal; }

  .floating-wrapper { position:absolute; border-radius:10px; touch-action:none; }
  .floating-wrapper img { display:block; width:100%; height:auto; border-radius:8px; box-shadow:0 8px 20px rgba(2,6,23,0.08); cursor:grab; }
  .floating-wrapper.dragging img { cursor:grabbing; opacity:0.95; }
  .resize-handle { position:absolute; width:12px; height:12px; background:#fff; border:1px solid rgba(15,23,42,0.12); border-radius:3px; right:-6px; bottom:-6px; cursor:se-resize; box-shadow:0 4px 10px rgba(2,6,23,0.06); }

  .footer { margin-top:8px; font-size:12px; color:var(--muted); display:flex; justify-content:space-between; align-items:center; }
  .toast { position:fixed; right:18px; bottom:18px; background:rgba(15,23,42,0.9); color:#fff; padding:8px 12px; border-radius:8px; box-shadow:0 8px 30px rgba(2,6,23,0.3); opacity:0; transform:translateY(8px); transition:all .28s; }
  .toast.show { opacity:1; transform:translateY(0); }

  input[type="file"]{ display:none; }

  /* Welcome content styles */
  .welcome-main { font-size:16px; color:#071033; line-height:1.5; }

  /* Smaller pro-tip */
  .pro-tip { font-size:12px; color:var(--muted); margin-top:8px; }
  .pro-tip .title { font-weight:600; color:#071033; font-size:13px; margin-bottom:6px; }
  .pro-tip .list { display:flex; flex-direction:column; gap:6px; margin-left:6px; }

  /* Reminder anchored to bottom of welcome panel */
  .reminder {
    position:absolute;
    left:var(--welcome-padding);
    right:var(--welcome-padding);
    bottom:var(--welcome-padding);
    height: var(--reminder-height);
    display:flex;
    align-items:center;
    gap:12px;
    font-size:13px;
    color:#92400e;
    background:rgba(249,115,22,0.06);
    padding:12px;
    border-radius:10px;
    border:1px solid rgba(249,115,22,0.12);
    box-sizing:border-box;
  }
  .reminder small { display:block; font-size:12px; color:var(--muted); margin-top:4px; }

  @media (max-width:880px){
    .sidebar{ display:none }
    .reminder { left:12px; right:12px; bottom:12px; }
    #welcome { padding-bottom: calc(12px + var(--reminder-height)); }
  }
</style>
</head>
<body>
<div class="app" id="app">
  <aside class="sidebar" aria-hidden="false">
    <div class="brand" role="banner">
      <div class="logo" aria-hidden="true">NS</div>
      <div class="brand-text">
        <div class="title">Note Scrolls</div>
        <div class="subtitle">Minimal, encrypted notes</div>
      </div>
    </div>

    <!-- Auth card (clean, auto-login) -->
    <div class="card" id="auth-card">
      <div id="login-view">
        <label for="login-user">Username</label>
        <input id="login-user" type="text" autocomplete="username" placeholder="username" />
        <label for="login-pass" style="margin-top:8px">Password</label>
        <input id="login-pass" type="password" autocomplete="current-password" placeholder="password" />
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="ghost" id="btn-show-register">Create account</button>
        </div>
        <p class="small-note" style="margin-top:8px">Your password never leaves your browser. Notes are encrypted locally.</p>
      </div>

      <div id="register-view" style="display:none">
        <label for="reg-user">Username</label>
        <input id="reg-user" type="text" placeholder="choose username" />
        <label for="reg-pass" style="margin-top:8px">Password</label>
        <input id="reg-pass" type="password" placeholder="choose password" />
        <label for="reg-pass2" style="margin-top:8px">Confirm</label>
        <input id="reg-pass2" type="password" placeholder="confirm password" />
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="primary" id="btn-register">Create</button>
          <button class="ghost" id="btn-show-login">Back</button>
        </div>
      </div>
    </div>

    <!-- User card -->
    <div class="user-card" id="user-card" aria-live="polite">
      <div class="user-row">
        <div class="user-avatar" id="user-avatar">‚Äî</div>
        <div class="user-meta">
          <div class="label">Logged in as</div>
          <div class="name" id="current-user">‚Äî</div>
        </div>
        <div class="user-actions">
          <button class="btn-logout" id="btn-logout">Logout</button>
        </div>
      </div>
    </div>

    <div class="small-note">Client-side encryption ‚Ä¢ No servers required</div>
  </aside>

  <main class="editor-wrap" aria-live="polite">
    <div class="topbar">
      <div class="tabs" id="tabs" aria-hidden="false" title="Tabs (double-click to rename, + to add)"></div>
      <div class="add-tab" id="btn-add-tab" title="Add tab">+</div>

      <div class="toolbar" role="toolbar" aria-label="Formatting toolbar">
        <button class="tool-btn" data-cmd="bold" title="Bold (Ctrl+B)" id="btn-bold" disabled><strong>B</strong></button>
        <button class="tool-btn" data-cmd="italic" title="Italic (Ctrl+I)" id="btn-italic" disabled><em>I</em></button>
        <button class="tool-btn" data-cmd="underline" title="Underline (Ctrl+U)" id="btn-underline" disabled><u>U</u></button>
        <button class="tool-btn" id="btn-link" title="Insert link (Ctrl+K)" disabled>üîó</button>
        <button class="tool-btn" id="btn-image" title="Insert image from computer" disabled>üñºÔ∏è</button>
      </div>
    </div>

    <div id="editor-container">
      <div id="welcome" aria-hidden="false">
        <h2>Welcome to Note Scrolls!</h2>

        <div class="welcome-main">
          Your personal space to save notes, screenshots, and any information you want to keep secure. Everything you store here is protected with safe, encrypted technology.
        </div>

        <!-- Smaller pro-tip block -->
        <div class="pro-tip" aria-hidden="false">
          <div class="title">‚ú® Pro Tip: Master Shortcuts for Speed</div>
          <div class="list">
            <div><strong>Ctrl + B</strong> ‚Üí Bold</div>
            <div><strong>Ctrl + U</strong> ‚Üí Underline</div>
            <div><strong>Ctrl + I</strong> ‚Üí Italic</div>
            <div><strong>Ctrl + K</strong> ‚Üí Insert Link</div>
            <div><strong>Ctrl + S</strong> ‚Üí Save instantly</div>
          </div>
        </div>

        <!-- Reminder anchored to bottom of the welcome panel -->
        <div class="reminder" role="note" aria-label="Important reminder">
          <div style="flex:0 0 auto; font-size:18px;">‚ö†Ô∏è</div>
          <div style="flex:1 1 auto">
            <div style="font-weight:700; color:#92400e;">Important Reminder</div>
            <small>Avoid using incognito mode or clearing your browser history ‚Äî doing so will permanently delete your saved notes.</small>
          </div>
        </div>
      </div>

      <div id="editor" contenteditable="true" spellcheck="true" aria-label="Secure note editor"></div>
    </div>

    <div class="footer">
      <div class="muted">Note Scrolls</div>
      <div class="muted">Lexend ‚Ä¢ Client-side encryption</div>
    </div>
  </main>
</div>

<input id="image-file" type="file" accept="image/*" />
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* =========================
   Small helpers & core logic
   (keeps previous behavior: accounts, tabs, encryption, images, shortcuts)
   ========================= */

function showToast(msg, ms=1400){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._timer);
  t._timer = setTimeout(()=> t.classList.remove('show'), ms);
}
function uid(prefix='t'){ return prefix + Math.random().toString(36).slice(2,9); }
function strToBuf(s){ return new TextEncoder().encode(s); }
function bufToStr(b){ return new TextDecoder().decode(b); }
function bufToB64(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); }

async function deriveVerifier(password, salt, iterations=150000){
  const keyMat = await crypto.subtle.importKey('raw', strToBuf(password), 'PBKDF2', false, ['deriveBits']);
  const bits = await crypto.subtle.deriveBits({name:'PBKDF2', salt: strToBuf(salt), iterations, hash:'SHA-256'}, keyMat, 256);
  return bufToB64(bits);
}
async function getAesKey(password, salt, iterations=150000){
  const keyMat = await crypto.subtle.importKey('raw', strToBuf(password), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2', salt: strToBuf(salt), iterations, hash:'SHA-256'}, keyMat, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
}
async function encryptString(plaintext, password, salt){
  const key = await getAesKey(password, salt);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, strToBuf(plaintext));
  return JSON.stringify({iv: Array.from(iv), ct: Array.from(new Uint8Array(ct))});
}
async function decryptString(payloadJson, password, salt){
  const obj = JSON.parse(payloadJson);
  const iv = new Uint8Array(obj.iv);
  const ct = new Uint8Array(obj.ct).buffer;
  const key = await getAesKey(password, salt);
  const plainBuf = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
  return bufToStr(plainBuf);
}

/* Account storage */
const LS_USERS = 'ns_users_v1';
function loadUsers(){ try{ return JSON.parse(localStorage.getItem(LS_USERS) || '{}'); }catch(e){return{}} }
function saveUsers(u){ localStorage.setItem(LS_USERS, JSON.stringify(u)); }

async function createAccount(username, password){
  username = username.trim().toLowerCase();
  if(!username || !password) throw new Error('Missing username or password');
  const users = loadUsers();
  if(users[username]) throw new Error('Username already exists');
  const salt = crypto.getRandomValues(new Uint8Array(12));
  const saltB64 = bufToB64(salt);
  const verifier = await deriveVerifier(password, saltB64);
  users[username] = { salt: saltB64, verifier };
  saveUsers(users);
  return true;
}
async function verifyLogin(username, password){
  username = username.trim().toLowerCase();
  const users = loadUsers();
  const record = users[username];
  if(!record) throw new Error('No such user');
  const v = await deriveVerifier(password, record.salt);
  if(v !== record.verifier) throw new Error('Invalid credentials');
  return record.salt;
}

/* App state */
let currentUser = null;
let currentSalt = null;
let currentPassword = null;
let tabs = [];
let activeTabId = null;
let zIndexCounter = 10;

const tabsEl = document.getElementById('tabs');
const editor = document.getElementById('editor');
const welcomeEl = document.getElementById('welcome');
const fileInput = document.getElementById('image-file');

function setAuthEnabled(enabled){
  ['btn-bold','btn-italic','btn-underline','btn-link','btn-image'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.disabled = !enabled;
  });
  document.getElementById('btn-add-tab').style.opacity = enabled ? '1' : '0.5';
}

/* Auto-login when both fields filled */
let loginAttemptTimer = null;
const loginUserInput = document.getElementById('login-user');
const loginPassInput = document.getElementById('login-pass');

function attemptAutoLoginDebounced(){
  clearTimeout(loginAttemptTimer);
  loginAttemptTimer = setTimeout(attemptAutoLogin, 450);
}
async function attemptAutoLogin(){
  const u = loginUserInput.value.trim();
  const p = loginPassInput.value;
  if(!u || !p) return;
  try{
    const salt = await verifyLogin(u,p);
    currentUser = u.toLowerCase();
    currentSalt = salt;
    currentPassword = p;
    onLogin();
    showToast('Logged in as ' + currentUser);
  }catch(err){
    showToast('Login failed');
  }
}
loginUserInput.addEventListener('input', attemptAutoLoginDebounced);
loginPassInput.addEventListener('input', attemptAutoLoginDebounced);

/* Register flow */
document.getElementById('btn-show-register').addEventListener('click', ()=>{
  document.getElementById('login-view').style.display='none';
  document.getElementById('register-view').style.display='block';
});
document.getElementById('btn-show-login').addEventListener('click', ()=>{
  document.getElementById('register-view').style.display='none';
  document.getElementById('login-view').style.display='block';
});
document.getElementById('btn-register').addEventListener('click', async ()=>{
  const u = document.getElementById('reg-user').value.trim();
  const p = document.getElementById('reg-pass').value;
  const p2 = document.getElementById('reg-pass2').value;
  if(!u || !p){ showToast('Enter username and password'); return; }
  if(p !== p2){ showToast('Passwords do not match'); return; }
  try{
    await createAccount(u,p);
    showToast('Account created. Type credentials to auto-login.');
    document.getElementById('register-view').style.display='none';
    document.getElementById('login-view').style.display='block';
    document.getElementById('reg-user').value=''; document.getElementById('reg-pass').value=''; document.getElementById('reg-pass2').value='';
  }catch(err){ showToast(err.message); }
});

/* Logout */
document.getElementById('btn-logout').addEventListener('click', ()=>{
  currentUser = null; currentSalt = null; currentPassword = null;
  document.getElementById('current-user').textContent = '‚Äî';
  document.getElementById('user-avatar').textContent = '‚Äî';
  tabs = []; activeTabId = null; renderTabs();
  editor.style.display = 'none'; welcomeEl.style.display = 'block';
  document.getElementById('auth-card').style.display = 'block';
  document.getElementById('user-card').style.display = 'none';
  setAuthEnabled(false);
  showToast('Logged out');
});

/* On login: load saved tabs and show editor */
async function onLogin(){
  document.getElementById('current-user').textContent = currentUser;
  document.getElementById('user-avatar').textContent = (currentUser[0] || 'U').toUpperCase();
  document.getElementById('auth-card').style.display = 'none';
  document.getElementById('user-card').style.display = 'block';
  setAuthEnabled(true);

  const key = 'notes_' + currentUser;
  const payload = localStorage.getItem(key);
  if(payload){
    try{
      const html = await decryptString(payload, currentPassword, currentSalt);
      const saved = JSON.parse(html);
      tabs = saved.tabs || [];
    }catch(e){
      tabs = [];
    }
  }else{
    tabs = [];
  }

  if(!tabs.length){
    const id = uid();
    tabs.push({ id, name: 'Untitled', content: '' });
    activeTabId = id;
  } else {
    activeTabId = tabs[0].id;
  }

  renderTabs();
  openActiveTab();
}

/* Tabs */
function createNewTab(name='Untitled'){
  if(!currentUser) { showToast('Log in to create a tab'); return; }
  const id = uid();
  tabs.push({ id, name, content: '' });
  activeTabId = id;
  renderTabs();
  openActiveTab();
}
document.getElementById('btn-add-tab').addEventListener('click', ()=>{
  if(!currentUser){ showToast('Log in to add tabs'); return; }
  createNewTab('Untitled');
});
function renderTabs(){
  tabsEl.innerHTML = '';
  tabs.forEach(t=>{
    const el = document.createElement('div');
    el.className = 'tab' + (t.id === activeTabId ? ' active' : '');
    el.title = t.name;

    const label = document.createElement('div');
    label.style.flex = '1';
    label.style.overflow = 'hidden';
    label.style.textOverflow = 'ellipsis';
    label.style.whiteSpace = 'nowrap';
    label.textContent = t.name;
    label.addEventListener('click', ()=>{ activeTabId = t.id; renderTabs(); openActiveTab(); });

    label.addEventListener('dblclick', (ev)=>{
      ev.stopPropagation();
      if(!currentUser) return;
      const newName = prompt('Rename tab:', t.name);
      if(newName !== null) { t.name = newName || 'Untitled'; renderTabs(); }
    });

    const close = document.createElement('div');
    close.className = 'close';
    close.innerHTML = '‚úï';
    close.title = 'Close tab';
    close.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      if(!currentUser) { showToast('Log in to close tabs'); return; }
      if(!confirm('Close "'+t.name+'"?')) return;
      tabs = tabs.filter(x=>x.id!==t.id);
      if(activeTabId === t.id) activeTabId = tabs.length ? tabs[0].id : null;
      renderTabs();
      openActiveTab();
    });

    el.appendChild(label);
    el.appendChild(close);
    tabsEl.appendChild(el);
  });
}

/* Open active tab */
function openActiveTab(){
  const t = tabs.find(x=>x.id===activeTabId);
  if(!t){
    welcomeEl.style.display = 'block';
    editor.style.display = 'none';
    return;
  }
  welcomeEl.style.display = 'none';
  editor.style.display = 'block';
  editor.innerHTML = t.content || '';
  attachFloatingWrappers();
  editor.focus();
}

/* Toolbar actions */
document.querySelectorAll('.tool-btn[data-cmd]').forEach(btn=>{
  btn.addEventListener('click', ()=>{ if(!currentUser) return; document.execCommand(btn.dataset.cmd, false, null); editor.focus(); });
});
document.getElementById('btn-link').addEventListener('click', ()=>{
  if(!currentUser) { showToast('Log in to insert links'); return; }
  const url = prompt('Enter URL (https://...)');
  if(!url) return;
  document.execCommand('createLink', false, url);
  setTimeout(()=> {
    const sel = window.getSelection();
    if(!sel.rangeCount) return;
    let node = sel.anchorNode;
    let el = node.nodeType===3 ? node.parentElement : node;
    if(el && el.tagName==='A'){ el.setAttribute('target','_blank'); el.setAttribute('rel','noopener'); }
  },50);
});
document.getElementById('btn-image').addEventListener('click', ()=>{ if(!currentUser) { showToast('Log in to insert images'); return; } fileInput.click(); });

/* Floating images */
function createFloatingImage(src, x=40, y=80, w=240){
  const wrapper = document.createElement('div');
  wrapper.className = 'floating-wrapper';
  wrapper.style.left = x + 'px';
  wrapper.style.top = y + 'px';
  wrapper.style.width = w + 'px';
  wrapper.style.zIndex = ++zIndexCounter;

  const img = document.createElement('img');
  img.src = src;
  img.draggable = false;

  const handle = document.createElement('div');
  handle.className = 'resize-handle';

  wrapper.appendChild(img);
  wrapper.appendChild(handle);
  editor.appendChild(wrapper);

  let dragging=false, offsetX=0, offsetY=0;
  wrapper.addEventListener('pointerdown', (ev)=>{
    if(ev.target === handle) return;
    dragging=true;
    wrapper.classList.add('dragging');
    const rect = wrapper.getBoundingClientRect();
    const editorRect = editor.getBoundingClientRect();
    offsetX = ev.clientX - rect.left;
    offsetY = ev.clientY - rect.top;
    wrapper.setPointerCapture(ev.pointerId);
  });
  wrapper.addEventListener('pointermove', (ev)=>{
    if(!dragging) return;
    const editorRect = editor.getBoundingClientRect();
    const nx = Math.max(0, Math.min(editor.clientWidth - wrapper.clientWidth, ev.clientX - editorRect.left - offsetX + editor.scrollLeft));
    const ny = Math.max(0, Math.min(editor.clientHeight - wrapper.clientHeight, ev.clientY - editorRect.top - offsetY + editor.scrollTop));
    wrapper.style.left = nx + 'px';
    wrapper.style.top = ny + 'px';
  });
  wrapper.addEventListener('pointerup', (ev)=>{
    dragging=false;
    wrapper.classList.remove('dragging');
    try{ wrapper.releasePointerCapture(ev.pointerId); }catch(e){}
    saveActiveTabContentToModel();
  });

  let resizing=false, startW=0, startX=0;
  handle.addEventListener('pointerdown', (ev)=>{
    ev.stopPropagation();
    resizing=true;
    startW = wrapper.clientWidth;
    startX = ev.clientX;
    handle.setPointerCapture(ev.pointerId);
  });
  handle.addEventListener('pointermove', (ev)=>{
    if(!resizing) return;
    const dx = ev.clientX - startX;
    const newW = Math.max(48, startW + dx);
    wrapper.style.width = newW + 'px';
  });
  handle.addEventListener('pointerup', (ev)=>{
    resizing=false;
    try{ handle.releasePointerCapture(ev.pointerId); }catch(e){}
    saveActiveTabContentToModel();
  });

  wrapper.addEventListener('click', ()=>{ wrapper.style.zIndex = ++zIndexCounter; });
  wrapper.addEventListener('dblclick', ()=>{
    if(confirm('Remove image?')){ wrapper.remove(); saveActiveTabContentToModel(); }
  });

  return wrapper;
}

function attachFloatingWrappers(){
  editor.querySelectorAll('.floating-wrapper').forEach(wrapper=>{
    if(wrapper._bound) return;
    wrapper._bound = true;
    const handle = wrapper.querySelector('.resize-handle') || (function(){ const h=document.createElement('div'); h.className='resize-handle'; wrapper.appendChild(h); return h; })();
    let dragging=false, offsetX=0, offsetY=0;
    wrapper.addEventListener('pointerdown', (ev)=>{
      if(ev.target === handle) return;
      dragging=true;
      wrapper.classList.add('dragging');
      const rect = wrapper.getBoundingClientRect();
      const editorRect = editor.getBoundingClientRect();
      offsetX = ev.clientX - rect.left;
      offsetY = ev.clientY - rect.top;
      wrapper.setPointerCapture(ev.pointerId);
    });
    wrapper.addEventListener('pointermove', (ev)=>{
      if(!dragging) return;
      const editorRect = editor.getBoundingClientRect();
      const nx = Math.max(0, Math.min(editor.clientWidth - wrapper.clientWidth, ev.clientX - editorRect.left - offsetX + editor.scrollLeft));
      const ny = Math.max(0, Math.min(editor.clientHeight - wrapper.clientHeight, ev.clientY - editorRect.top - offsetY + editor.scrollTop));
      wrapper.style.left = nx + 'px';
      wrapper.style.top = ny + 'px';
    });
    wrapper.addEventListener('pointerup', (ev)=>{
      dragging=false;
      wrapper.classList.remove('dragging');
      try{ wrapper.releasePointerCapture(ev.pointerId); }catch(e){}
      saveActiveTabContentToModel();
    });
    let resizing=false, startW=0, startX=0;
    handle.addEventListener('pointerdown', (ev)=>{
      ev.stopPropagation();
      resizing=true;
      startW = wrapper.clientWidth;
      startX = ev.clientX;
      handle.setPointerCapture(ev.pointerId);
    });
    handle.addEventListener('pointermove', (ev)=>{
      if(!resizing) return;
      const dx = ev.clientX - startX;
      const newW = Math.max(48, startW + dx);
      wrapper.style.width = newW + 'px';
    });
    handle.addEventListener('pointerup', (ev)=>{
      resizing=false;
      try{ handle.releasePointerCapture(ev.pointerId); }catch(e){}
      saveActiveTabContentToModel();
    });
    wrapper.addEventListener('click', ()=>{ wrapper.style.zIndex = ++zIndexCounter; });
    wrapper.addEventListener('dblclick', ()=>{
      if(confirm('Remove image?')){ wrapper.remove(); saveActiveTabContentToModel(); }
    });
  });
}

/* File input */
fileInput.addEventListener('change', (ev)=>{
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = (e)=>{
    let x = 40, y = 80;
    const sel = window.getSelection();
    if(sel.rangeCount){
      const range = sel.getRangeAt(0);
      const rect = range.getBoundingClientRect();
      const editorRect = editor.getBoundingClientRect();
      x = Math.max(8, rect.left - editorRect.left + editor.scrollLeft);
      y = Math.max(8, rect.top - editorRect.top + editor.scrollTop);
    }
    createFloatingImage(e.target.result, x, y, 240);
    saveActiveTabContentToModel();
  };
  reader.readAsDataURL(f);
  fileInput.value = '';
});

/* Paste images (screenshots) */
editor.addEventListener('paste', (e)=>{
  const items = e.clipboardData && e.clipboardData.items;
  if(!items) return;
  let handled = false;
  for(const it of items){
    if(it.type.indexOf('image') !== -1){
      const file = it.getAsFile();
      const reader = new FileReader();
      reader.onload = (ev)=>{
        let x = 40, y = 80;
        const sel = window.getSelection();
        if(sel.rangeCount){
          const range = sel.getRangeAt(0);
          const rect = range.getBoundingClientRect();
          const editorRect = editor.getBoundingClientRect();
          x = Math.max(8, rect.left - editorRect.left + editor.scrollLeft);
          y = Math.max(8, rect.top - editorRect.top + editor.scrollTop);
        }
        createFloatingImage(ev.target.result, x, y, 240);
        saveActiveTabContentToModel();
      };
      reader.readAsDataURL(file);
      handled = true;
    }
  }
  if(handled) e.preventDefault();
});

/* Save/load encrypted notes */
async function saveNote(){
  if(!currentUser || !currentPassword || !currentSalt){ showToast('Please log in first'); return; }
  saveActiveTabContentToModel();
  const payloadObj = { tabs };
  try{
    const payload = await encryptString(JSON.stringify(payloadObj), currentPassword, currentSalt);
    localStorage.setItem('notes_' + currentUser, payload);
    localStorage.setItem('notes_' + currentUser + '_ts', Date.now().toString());
    showToast('Saved securely');
  }catch(e){
    console.error(e);
    showToast('Save failed');
  }
}
async function loadNote(){
  if(!currentUser || !currentPassword || !currentSalt){ showToast('Please log in first'); return; }
  const payload = localStorage.getItem('notes_' + currentUser);
  if(!payload){ showToast('No saved note found'); return; }
  try{
    const html = await decryptString(payload, currentPassword, currentSalt);
    const saved = JSON.parse(html);
    tabs = saved.tabs || [];
    if(!tabs.length){
      const id = uid();
      tabs.push({ id, name: 'Untitled', content: '' });
      activeTabId = id;
    } else {
      activeTabId = tabs[0].id;
    }
    renderTabs();
    openActiveTab();
    showToast('Loaded');
  }catch(e){
    console.error(e);
    showToast('Could not decrypt');
  }
}

/* Save active editor content into model */
function saveActiveTabContentToModel(){
  const t = tabs.find(x=>x.id===activeTabId);
  if(!t) return;
  t.content = editor.innerHTML;
}

/* Keyboard shortcuts */
document.addEventListener('keydown', (e)=>{
  if(e.ctrlKey && e.key.toLowerCase() === 's'){
    e.preventDefault();
    if(currentUser) saveNote();
    else showToast('Log in to save');
    return;
  }
  if(e.ctrlKey && e.key.toLowerCase() === 't'){
    e.preventDefault();
    if(currentUser) createNewTab('Untitled');
    else showToast('Log in to create a tab');
    return;
  }
  if(!e.ctrlKey) return;
  const key = e.key.toLowerCase();
  if(key === 'b'){ e.preventDefault(); if(currentUser) document.execCommand('bold'); }
  if(key === 'i'){ e.preventDefault(); if(currentUser) document.execCommand('italic'); }
  if(key === 'u'){ e.preventDefault(); if(currentUser) document.execCommand('underline'); }
  if(key === 'k'){ e.preventDefault(); if(currentUser) document.getElementById('btn-link').click(); }
});

/* Editor input -> model (debounced) */
let changeTimer = null;
editor.addEventListener('input', ()=>{
  clearTimeout(changeTimer);
  changeTimer = setTimeout(()=>{ saveActiveTabContentToModel(); }, 600);
});

/* Init */
(function init(){
  setAuthEnabled(false);
  tabs = [];
  editor.style.display = 'none';
  welcomeEl.style.display = 'block';
})();
</script>
</body>
</html>
